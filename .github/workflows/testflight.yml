name: Deploy To TestFlight

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: testflight-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  deploy-testflight:
    runs-on: macos-latest
    timeout-minutes: 90
    env:
      PROJECT_PATH: WorldCrush.xcodeproj
      SCHEME: WorldCrush
      TEAM_ID: MM9BHDUA97
      APP_BUNDLE_ID: com.pedrocarrasco.WorldCrush
      WIDGET_BUNDLE_ID: com.pedrocarrasco.WorldCrush.wordsearchwidget
      ARCHIVE_PATH: ${{ github.workspace }}/build/WorldCrush.xcarchive
      EXPORT_PATH: ${{ github.workspace }}/build/WorldCrush-export
      EXPORT_OPTIONS_PLIST: ${{ github.workspace }}/build/ExportOptions.plist
      APPSTORE_CERTIFICATES_FILE_BASE64: ${{ secrets.APPSTORE_CERTIFICATES_FILE_BASE64 }}
      APPSTORE_CERTIFICATES_PASSWORD: ${{ secrets.APPSTORE_CERTIFICATES_PASSWORD }}
      APPSTORE_API_PRIVATE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
      APPSTORE_API_KEY_ID: ${{ vars.APPSTORE_API_KEY_ID }}
      APPSTORE_ISSUER_ID: ${{ vars.APPSTORE_ISSUER_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Preflight credentials
        id: preflight
        run: |
          missing=0
          for key in APPSTORE_CERTIFICATES_FILE_BASE64 APPSTORE_CERTIFICATES_PASSWORD APPSTORE_API_PRIVATE_KEY APPSTORE_API_KEY_ID APPSTORE_ISSUER_ID; do
            if [[ -z "${!key:-}" ]]; then
              echo "Missing $key"
              missing=1
            fi
          done

          if [[ "$missing" -eq 1 ]]; then
            echo "ready=false" >> "$GITHUB_OUTPUT"
          else
            echo "ready=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Select Xcode version
        if: ${{ steps.preflight.outputs.ready == 'true' }}
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Import signing certificate
        if: ${{ steps.preflight.outputs.ready == 'true' }}
        uses: apple-actions/import-codesign-certs@v6
        with:
          p12-file-base64: ${{ secrets.APPSTORE_CERTIFICATES_FILE_BASE64 }}
          p12-password: ${{ secrets.APPSTORE_CERTIFICATES_PASSWORD }}

      - name: Download app provisioning profile
        if: ${{ steps.preflight.outputs.ready == 'true' }}
        uses: apple-actions/download-provisioning-profiles@v4
        with:
          bundle-id: ${{ env.APP_BUNDLE_ID }}
          profile-type: IOS_APP_STORE
          issuer-id: ${{ vars.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ vars.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

      - name: Download widget provisioning profile
        if: ${{ steps.preflight.outputs.ready == 'true' }}
        uses: apple-actions/download-provisioning-profiles@v4
        with:
          bundle-id: ${{ env.WIDGET_BUNDLE_ID }}
          profile-type: IOS_APP_STORE
          issuer-id: ${{ vars.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ vars.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

      - name: Build export options plist
        if: ${{ steps.preflight.outputs.ready == 'true' }}
        run: |
          mkdir -p "$(dirname "$EXPORT_OPTIONS_PLIST")"
          cat > "$EXPORT_OPTIONS_PLIST" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "https://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>destination</key>
            <string>export</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>teamID</key>
            <string>${TEAM_ID}</string>
          </dict>
          </plist>
          EOF

      - name: Compute build number
        if: ${{ steps.preflight.outputs.ready == 'true' }}
        id: build_number
        run: |
          echo "value=$(date -u +%Y%m%d%H%M%S)" >> "$GITHUB_OUTPUT"

      - name: Archive app
        if: ${{ steps.preflight.outputs.ready == 'true' }}
        run: |
          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "$ARCHIVE_PATH" \
            CODE_SIGN_STYLE=Automatic \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            CURRENT_PROJECT_VERSION="${{ steps.build_number.outputs.value }}" \
            clean archive

      - name: Export IPA
        if: ${{ steps.preflight.outputs.ready == 'true' }}
        run: |
          mkdir -p "$EXPORT_PATH"
          xcodebuild \
            -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$EXPORT_PATH" \
            -exportOptionsPlist "$EXPORT_OPTIONS_PLIST"

      - name: Locate IPA
        if: ${{ steps.preflight.outputs.ready == 'true' }}
        id: locate_ipa
        run: |
          IPA_PATH="$(find "$EXPORT_PATH" -maxdepth 1 -type f -name '*.ipa' | head -n 1)"
          if [[ -z "$IPA_PATH" ]]; then
            echo "No IPA found in $EXPORT_PATH" >&2
            exit 1
          fi
          echo "path=$IPA_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload build to TestFlight
        if: ${{ steps.preflight.outputs.ready == 'true' }}
        uses: apple-actions/upload-testflight-build@v4
        with:
          app-path: ${{ steps.locate_ipa.outputs.path }}
          issuer-id: ${{ vars.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ vars.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

      - name: Missing credentials notice
        if: ${{ steps.preflight.outputs.ready != 'true' }}
        run: |
          echo "Skipping GitHub-hosted TestFlight upload because required secrets/variables are not configured."
          echo "Required secrets: APPSTORE_CERTIFICATES_FILE_BASE64, APPSTORE_CERTIFICATES_PASSWORD, APPSTORE_API_PRIVATE_KEY"
          echo "Required variables: APPSTORE_API_KEY_ID, APPSTORE_ISSUER_ID"
